// CloudRMM Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Core Hierarchy Models
// ============================================

model Partner {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  logo          String?
  primaryColor  String?
  customDomain  String?  @unique
  billingEmail  String
  status        PartnerStatus @default(ACTIVE)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  // Relations
  organizations Organization[]
  users         UserRoleAssignment[]

  @@index([slug])
  @@index([status])
  @@map("partners")
}

model Organization {
  id            String   @id @default(cuid())
  partnerId     String
  name          String
  slug          String
  status        OrganizationStatus @default(ACTIVE)
  billingPlan   String?
  contactEmail  String

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  // Relations
  partner       Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  sites         Site[]
  devices       Device[]
  users         UserRoleAssignment[]

  @@unique([partnerId, slug])
  @@index([partnerId])
  @@index([status])
  @@map("organizations")
}

model Site {
  id              String   @id @default(cuid())
  organizationId  String
  name            String
  address         String?
  city            String?
  state           String?
  country         String?
  zipCode         String?
  timezone        String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  devices         Device[]
  users           UserRoleAssignment[]

  @@index([organizationId])
  @@map("sites")
}

model Device {
  id              String   @id @default(cuid())
  siteId          String
  organizationId  String
  hostname        String
  ipAddress       String?
  macAddress      String?
  os              String
  osVersion       String
  agentVersion    String
  status          DeviceStatus @default(OFFLINE)
  lastSeenAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  site            Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@index([organizationId])
  @@index([status])
  @@index([hostname])
  @@map("devices")
}

// ============================================
// User & Access Control Models
// ============================================

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  firstName   String
  lastName    String
  status      UserStatus @default(ACTIVE)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Relations
  roleAssignments UserRoleAssignment[]
  auditLogs       AuditLog[]

  @@index([email])
  @@index([status])
  @@map("users")
}

model Role {
  id          String     @id @default(cuid())
  name        String
  scope       RoleScope
  permissions String[]   // Array of permission strings
  description String?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  assignments UserRoleAssignment[]

  @@unique([name, scope])
  @@index([scope])
  @@map("roles")
}

model UserRoleAssignment {
  id          String     @id @default(cuid())
  userId      String
  roleId      String
  scopeType   RoleScope
  scopeId     String     // partnerId, orgId, or siteId

  createdAt   DateTime   @default(now())

  // Relations
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  partner     Partner?   @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  site        Site?      @relation(fields: [scopeId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, scopeType, scopeId])
  @@index([userId])
  @@index([roleId])
  @@index([scopeType, scopeId])
  @@map("user_role_assignments")
}

// ============================================
// Audit & Compliance
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  resource    String
  resourceId  String?
  details     Json?
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  // Relations
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// Enums
// ============================================

enum PartnerStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum DeviceStatus {
  ONLINE
  OFFLINE
  WARNING
  ERROR
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum RoleScope {
  PLATFORM
  PARTNER
  ORGANIZATION
  SITE
}
